// A simple tennis-game
//
// Use the arrow keys to move the player

#include <stdio.h>

#include "qmon.h"
#include "sysdef.h"
#include "sprite.h"

// convenient mechanism to access QNICE's Memory Mapped IO registers
#define MMIO( __x ) *((unsigned int volatile *) __x )

static const t_sprite_bitmap player = {
   0x0000, 0x0000, 0x0000, 0x1111, 0x1111, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0111, 0x1111, 0x1111, 0x1110, 0x0000, 0x0000,
   0x0000, 0x0001, 0x1111, 0x1111, 0x1111, 0x1111, 0x1000, 0x0000,
   0x0000, 0x0011, 0x1111, 0x1111, 0x1111, 0x1111, 0x1100, 0x0000,
   0x0000, 0x0111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1110, 0x0000,
   0x0000, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x0000,
   0x0001, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1000,
   0x0011, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1100,
   0x0011, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1100,
   0x0111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1110,
   0x0111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1110,
   0x0111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1110,
   0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111,
   0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111,
   0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111,
   0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111, 0x1111,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

static const t_sprite_bitmap ball = {
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0111, 0x1110, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0001, 0x1111, 0x1111, 0x1000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0011, 0x1111, 0x1111, 0x1100, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0111, 0x1111, 0x1111, 0x1110, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0111, 0x1111, 0x1111, 0x1110, 0x0000, 0x0000,
   0x0000, 0x0000, 0x1111, 0x1111, 0x1111, 0x1111, 0x0000, 0x0000,
   0x0000, 0x0000, 0x1111, 0x1111, 0x1111, 0x1111, 0x0000, 0x0000,
   0x0000, 0x0000, 0x1111, 0x1111, 0x1111, 0x1111, 0x0000, 0x0000,
   0x0000, 0x0000, 0x1111, 0x1111, 0x1111, 0x1111, 0x0000, 0x0000,
   0x0000, 0x0000, 0x1111, 0x1111, 0x1111, 0x1111, 0x0000, 0x0000,
   0x0000, 0x0000, 0x1111, 0x1111, 0x1111, 0x1111, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0111, 0x1111, 0x1111, 0x1110, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0111, 0x1111, 0x1111, 0x1110, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0011, 0x1111, 0x1111, 0x1100, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0001, 0x1111, 0x1111, 0x1000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0111, 0x1110, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
   0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000
};

static void game_init()
{
   MMIO(VGA_STATE) &= ~VGA_EN_HW_CURSOR;  // hide cursor
   MMIO(VGA_STATE) |= VGA_EN_SPRITE;      // enable sprites

   qmon_vga_cls();
   sprite_clear_all();

   t_sprite_palette palette = sprite_palette_transparent;
   palette[1] = VGA_COLOR_RED;
   sprite_set_palette(0, palette);
   sprite_set_bitmap(0, ball);
   sprite_set_config(0, VGA_SPRITE_CSR_VISIBLE);
} // end of game_init

static void game_exit()
{
   MMIO(VGA_STATE) |= VGA_EN_HW_CURSOR;   // show cursor
   MMIO(VGA_STATE) &= ~VGA_EN_SPRITE;     // disable sprites
   qmon_vga_cls();
   sprite_clear_all();
} // end of game_exit

static int move_up = 0;
static int move_down = 0;
static int move_left = 0;
static int move_right = 0;

static int pos_x = 300;
static int pos_y = 200;

// This function is called once per frame, i.e. 60 times a second
static int game_update()
{
   int ev = MMIO(IO_KBD_EVENT);
   switch (ev)
   {
      case KBD_CUR_UP    : move_up = 1; break;
      case KBD_CUR_DOWN  : move_down = 1; break;
      case KBD_CUR_LEFT  : move_left = 1; break;
      case KBD_CUR_RIGHT : move_right = 1; break;
      case KBD_CUR_UP    | 0x8000 : move_up = 0; break;
      case KBD_CUR_DOWN  | 0x8000 : move_down = 0; break;
      case KBD_CUR_LEFT  | 0x8000 : move_left = 0; break;
      case KBD_CUR_RIGHT | 0x8000 : move_right = 0; break;
      case 'q' : return 1;
   }

   pos_x += move_right - move_left;
   pos_y += move_down - move_up;

   return 0;
} // end of game_update

static void game_draw()
{
   sprite_set_position(0, pos_x, pos_y);
} // end of game_draw

int main()
{
   game_init();

   while (1)
   {
      while (MMIO(VGA_SCAN_LINE) < 480) {}
      game_draw();
      if (game_update())
         break;
      while (MMIO(VGA_SCAN_LINE) >= 480) {}
   }

   game_exit();

   return 0;
} // end of main

